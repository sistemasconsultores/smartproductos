version: "3.8"

services:
  app:
    image: smartenrich:latest
    command: ["npm", "run", "docker-start"]
    env_file: .env
    ports:
      - "3100:3100"
    networks:
      - CFNet
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=CFNet"
        - "traefik.http.routers.smartenrich.rule=Host(`smartenrich.automasc.com`)"
        - "traefik.http.routers.smartenrich.entrypoints=websecure"
        - "traefik.http.routers.smartenrich.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.smartenrich.loadbalancer.server.port=3100"
      resources:
        limits:
          cpus: "1.0"
          memory: 1024M
    volumes:
      - smartenrich-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3100/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  worker:
    image: smartenrich:latest
    command: ["npm", "run", "worker"]
    env_file: .env
    networks:
      - CFNet
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: "1.5"
          memory: 2048M

networks:
  CFNet:
    external: true

volumes:
  smartenrich-data:
    driver: local
